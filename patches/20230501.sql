# ************************************************************
# 20230501.sql
# 
# This patch adds the User Management scope
# for the Tenant Admin role and able to edit Failed Login Attempts.
# ************************************************************

#
# 1) Update Definitions table with new editable field for the Tenant Admin role
#

LOCK TABLES `appbuilder_definition` WRITE;
INSERT INTO `appbuilder_definition` (`id`, `name`, `type`, `json`, `createdAt`, `updatedAt`)
VALUES
	('1b681750-fcb2-4b20-8c8d-7e76247c5e4a', 'Tenant User Admin.menu', 'view', '{"id":"1b681750-fcb2-4b20-8c8d-7e76247c5e4a","type":"view","key":"menu","icon":"th-large","name":"Tenant User Admin.menu","settings":{"columnSpan":1,"rowSpan":1,"orientation":"x","buttonStyle":"ab-menu-default","menuAlignment":"ab-menu-right","menuInToolbar":"1","menuPadding":"10","menuTheme":"webix_dark","menuPosition":"right","menuTextLeft":"","order":[{"parent":"0","position":"0","icon":"plus","type":"page","pageId":"2c9b5a12-7249-43ca-ab29-0fa171c7489a","isChecked":"true","translations":[{"language_code":"en","label":"Add User - Default Roles","aliasname":"Add User"}]}],"height":0,"pages":[]},"accessLevels":{},"translations":[{"language_code":"en","label":"Tenant User Admin.menu","menuTextLeft":"User Admin","menuTextCenter":"","menuTextRight":""}],"viewIDs":[],"position":{"dx":1,"dy":1,"x":0,"y":0},"isRoot":false}', '2022-02-08 03:51:22', '2023-05-01 04:38:13'),
	('227bcbb3-437f-4bb5-a5a1-ec3198696206', 'Site Administration', 'application', '{"id":"227bcbb3-437f-4bb5-a5a1-ec3198696206","type":"application","name":"Site Administration","icon":"fa-rocket","isSystemObject":1,"json":{"translations":[{"language_code":"en","label":"Site Administration","description":"Manage access to the web site for our users"}],"name":"Site Administration","versionData":{"versionNumber":"1.0.0","changeLog":{"1.0.0":{"author":"N/A","version":"1.0.0","keepVersion":0,"commitMessage":"Initial Version","timestamp":"2023-05-01T04:26:52.408Z","versionNumber":"1.0.0"}}},"objectIDs":["08826ac7-4b33-4745-a3d7-f7831ca4ff59","090cde9f-71ba-4597-bdb2-79b84816e86e","42658374-ed94-49af-90a4-05c048b6f041","228e3d91-5e42-49ec-b37c-59323ae433a1","c33692f3-26b7-4af3-a02e-139fb519296d","af10e37c-9b3a-4dc6-a52a-85d52320b659","d36ae4c8-edef-48d8-bd9c-79a0edcaa067","d84cd351-d96c-490f-9afb-2a0b880ca0ec","4a9d89c9-f4eb-41af-91e4-909eff389f3e","2ba85be0-78db-4eda-ba43-c2c4e3831849"],"objectListSettings":{"isOpen":false,"searchText":"","sortDirection":"asc","isGroup":false},"hintIDs":[],"queryIDs":[],"datacollectionIDs":["190a0a12-ea9e-4764-a6c9-be6f8b40417d","bbef27bb-4673-468a-8c7b-ddd8c6454f19","4f801bac-c305-4067-bb2b-5968d0d2ae97","304a4a2c-1374-4f67-8a98-b5dc331df7a1","bb6440f4-2b73-4218-9482-4e1447ef90c6","2c46aa53-ebb4-47b2-9e49-66fb67dec962","a415f8a4-3b9f-4e29-878e-70599d365a74","d66b0694-921a-4504-93c2-2338ae747521","a28b6597-5406-405a-a30c-029c9acd667d","57e2acf3-3315-4896-9182-b96768f95fa3"],"pageIDs":["d92211f7-c0d7-4762-bee5-f09eebd9bcda"],"processIDs":["3ce49e36-4c1b-4058-b734-126865fdd8d9","9469a93e-3f0a-4cbf-9385-fba24eca0347"]},"roleAccess":["6cc04894-a61b-4fb5-b3e5-b8c3f78bd331","dd6c2d34-0982-48b7-bc44-2456474edbea","e1be4d22-1d00-4c34-b205-ef84b8334b19","ee52974b-5276-427f-ad4c-f29af6b5caaf"],"translations":[{"language_code":"en","label":"Site Administration","description":"Manage access to the web site for our users"}],"isAccessManaged":1,"isTranslationManaged":0,"isTutorialManaged":0,"accessManagers":{"useRole":1,"role":["dd6c2d34-0982-48b7-bc44-2456474edbea","6cc04894-a61b-4fb5-b3e5-b8c3f78bd331"],"useAccount":0,"account":null},"translationManagers":{"useRole":0,"role":null,"useAccount":0,"account":null},"tutorialManagers":{"useRole":0,"role":null,"useAccount":0,"account":null}}', '2020-09-04 23:05:25', '2023-05-01 04:33:01'),
	('2512768a-d4ee-435c-8244-d34e61febc85', 'Edit User - Tenant Admin.form', 'view', '{"id":"2512768a-d4ee-435c-8244-d34e61febc85","type":"view","key":"form","icon":"list-alt","name":"Edit User - Tenant Admin.form","settings":{"columns":1,"removable":true,"movable":true,"labelPosition":"left","showLabel":1,"clearOnLoad":0,"clearOnSave":0,"labelWidth":120,"height":200,"dataviewID":"57e2acf3-3315-4896-9182-b96768f95fa3","submitRules":[{"selectedAction":"ABViewRuleActionFormSubmitRuleClosePopup","queryRules":{"glue":"and","rules":[]},"actionSettings":{}}],"gravity":[],"recordRules":[]},"accessLevels":{},"translations":[{"language_code":"en","label":"Edit User - Tenant Admin.form"}],"viewIDs":["42312aad-f30e-4660-8ce8-850e56d38311","a52745dd-412e-48f2-b000-d215ad6d95d4","c1f1cf21-92fe-4352-acc3-3eee6858ba2d","4d966f5f-66f1-4bc1-bd28-efec9df0b97c"],"position":{"dx":1,"dy":1},"isRoot":false}', '2022-02-08 07:31:26', '2023-05-01 04:34:52'),
	('4c9c67d1-d687-470d-aa99-4b37fb0dbbb0', 'Users', 'view', '{"id":"4c9c67d1-d687-470d-aa99-4b37fb0dbbb0","type":"view","key":"viewcontainer","icon":"braille","tabicon":"user-circle-o","name":"Users","settings":{"columns":1,"removable":true,"movable":true,"height":0},"accessLevels":{"ee52974b-5276-427f-ad4c-f29af6b5caaf":"2"},"translations":[{"language_code":"en","label":"Users"}],"viewIDs":["1b681750-fcb2-4b20-8c8d-7e76247c5e4a","6197010c-d53e-40fb-979f-4a984044b27c","854be79b-b11b-4f3b-a345-69d471776435"],"position":{"dx":1,"dy":1},"isRoot":false}', '2022-02-08 03:45:24', '2023-05-01 04:38:13'),
	('4d966f5f-66f1-4bc1-bd28-efec9df0b97c', 'Edit User - Tenant Admin.form.button', 'view', '{"id":"4d966f5f-66f1-4bc1-bd28-efec9df0b97c","type":"view","key":"button","icon":"square","name":"Edit User - Tenant Admin.form.button","settings":{"includeSave":true,"includeCancel":false,"includeReset":false,"isDefault":true,"height":0,"translations":[]},"accessLevels":{},"translations":[{"language_code":"en","label":"Edit User - Tenant Admin.form.button"}],"viewIDs":[],"position":{"dx":1,"dy":1,"y":3,"x":0},"isRoot":false}', '2022-02-08 07:31:38', '2023-05-01 04:34:49'),
	('6197010c-d53e-40fb-979f-4a984044b27c', 'Users.grid', 'view', '{"id":"6197010c-d53e-40fb-979f-4a984044b27c","type":"view","key":"grid","icon":"table","name":"Users.grid","settings":{"columnSpan":1,"rowSpan":1,"dataviewID":"57e2acf3-3315-4896-9182-b96768f95fa3","isEditable":0,"massUpdate":0,"allowDelete":0,"isSortable":0,"isExportable":0,"hideHeader":0,"labelAsField":0,"hideButtons":0,"gridFilter":{"filterOption":0,"queryRules":[],"isGlobalToolbar":0},"detailsPage":"","editPage":"759327cb-6a80-4df6-8b28-2378fecad9c3","detailsTab":"","editTab":"","height":0,"groupBy":"","objectWorkspace":{"frozenColumnID":"","hiddenFields":["uuid","password","salt","failedLogins","sendEmailNotifications","languageCode","uploadedBy","SITE_PROCESS_INSTANCE","SITE_PROCESS_FORM_users","SITE_PROCESS_FORM_responder","SITE_SCOPE","AB_CARS_Staff_Staff User","AB_Moderator_User","AB_Moderator_Requesters","AB_MyTeamFinance_ResponsibilityCenter_Owner","AB_Profile_Operations_Users","AB_DonationTracking_ExpenseReport_Reviewer","AB_DonationTracking_ReportItem_User","AB_AccountingApp_Batch_User","AB_Projectw_Created By","AB_Projectw_Approver","AB_Projectw_Overseer","AB_DonationTracking_Donations_User","AB_StaffDonation_User","AB_ProjectIncome_Funding Leader","AB_DonationTracking_Receipt_User","AB_AccountTransfer_Recipient","AB_AccountTransfer_Sender","AB_CARS_Staff_Staff User","image_id"]},"padding":17,"showToolbar":1,"columnConfig":[],"saveLocal":1,"trackView":0,"frozenColumnID":"","hiddenFields":["uuid","password","salt","sendEmailNotifications","languageCode","uploadedBy","SITE_PROCESS_INSTANCE","SITE_PROCESS_FORM_users","SITE_PROCESS_FORM_responder","SITE_SCOPE","AB_CARS_Staff_Staff User","AB_Moderator_User","AB_Moderator_Requesters","AB_MyTeamFinance_ResponsibilityCenter_Owner","AB_Profile_Operations_Users","AB_DonationTracking_ExpenseReport_Reviewer","AB_DonationTracking_ReportItem_User","AB_AccountingApp_Batch_User","AB_Projectw_Created By","AB_Projectw_Approver","AB_Projectw_Overseer","AB_DonationTracking_Donations_User","AB_StaffDonation_User","AB_ProjectIncome_Funding Leader","AB_DonationTracking_Receipt_User","AB_AccountTransfer_Recipient","AB_AccountTransfer_Sender","AB_CARS_Staff_Staff User","image_id"],"summaryColumns":[],"countColumns":[]},"accessLevels":{},"translations":[{"language_code":"en","label":"Users.grid"}],"viewIDs":[],"position":{"dx":1,"dy":1,"x":0,"y":2},"isRoot":false}', '2022-02-08 03:55:02', '2023-05-01 04:38:13'),
	('854be79b-b11b-4f3b-a345-69d471776435', 'Users.data-filter', 'view', '{"id":"854be79b-b11b-4f3b-a345-69d471776435","type":"view","key":"data-filter","icon":"filter","name":"Users.data-filter","settings":{"height":0,"columnSpan":1,"rowSpan":1,"name":"Users.data-filter","viewType":"advanced","dataviewID":"57e2acf3-3315-4896-9182-b96768f95fa3","field":"","showFilter":1,"showSort":1},"accessLevels":{},"translations":[{"language_code":"en","label":"Users.data-filter"}],"viewIDs":[],"position":{"dx":1,"dy":1,"x":0,"y":1},"isRoot":false}', '2023-03-20 05:17:31', '2023-05-01 04:38:13'),
	('c1f1cf21-92fe-4352-acc3-3eee6858ba2d', 'Edit User - Tenant Admin.form.numberbox', 'view', '{"id":"c1f1cf21-92fe-4352-acc3-3eee6858ba2d","type":"view","key":"numberbox","icon":"hashtag","settings":{"objectId":"228e3d91-5e42-49ec-b37c-59323ae433a1","fieldId":"fed7b05c-6c51-4632-8578-353da483244e","height":0,"isStepper":0},"accessLevels":{},"translations":[{"language_code":"en","label":"Edit User - Tenant Admin.form.numberbox"}],"viewIDs":[],"position":{"dx":1,"dy":1},"isRoot":false,"views":[]}', '2023-05-01 04:34:49', '2023-05-01 04:34:49')
ON DUPLICATE KEY UPDATE
    name = VALUES(name),
    type = VALUES(type),
    json = VALUES(json),
    createdAt = VALUES(createdAt),
    updatedAt = VALUES(updatedAt);

UNLOCK TABLES;

#
# 2) Create the User Management scope and assign to the Tenant Admin role
#

LOCK TABLES `SITE_SCOPE` WRITE;
INSERT IGNORE INTO `SITE_SCOPE` (`uuid`, `created_at`, `updated_at`, `translations`, `Filters`,`objectIds`, `createdBy`)
VALUES
	('fc5055b6-9f96-4ee6-9f38-8d8a708661a7', '2023-05-01 05:36:35', '2023-05-01 05:36:35', '[{"language_code":"en","name":"User Management","description":"Able to access site user."}]', '{"glue":"and","rules":[{"key":"9de6e282-277a-459b-aba1-66539e0037ea","rule":"not_contains","value":"753f062f-6083-4407-9878-1318ea0cd6a4"},{"key":"f1fccbbf-f226-4e9e-aa6a-119f8cc309b6","rule":"not_equal","value":"Switcheroo"},{"key":"f1fccbbf-f226-4e9e-aa6a-119f8cc309b6","rule":"not_equal","value":"System Admin"},{"key":"f1fccbbf-f226-4e9e-aa6a-119f8cc309b6","rule":"not_equal","value":"System Builder"}]}', '["228e3d91-5e42-49ec-b37c-59323ae433a1","c33692f3-26b7-4af3-a02e-139fb519296d"]', 'admin');
UNLOCK TABLES;
LOCK TABLES `AB_JOINMN_SCOPE_ROLE_roles` WRITE;
INSERT IGNORE INTO `AB_JOINMN_SCOPE_ROLE_roles` (`ROLE`, `SCOPE`)
VALUES
	('ee52974b-5276-427f-ad4c-f29af6b5caaf', 'fc5055b6-9f96-4ee6-9f38-8d8a708661a7');
UNLOCK TABLES;
